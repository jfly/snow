#!/usr/bin/env bash

set -euo pipefail
shopt -s globstar

if [ $# -eq 0 ]; then

    echo "Usage: $0 [target]

To deploy all machines:

    ./deploy '*'

To deploy one machine:

    ./deploy 'dallben'
"
    exit 1
fi

function build_containers() {
    for f in k8s/**/Dockerfile; do
        dir=$(dirname "$f")
        fq_image_name=containers.clark.snowdon.jflei.com/$(basename "$dir"):latest
        docker build "$dir" -t "$fq_image_name"
        docker push "$fq_image_name"
    done
}

function deploy_k8s() {
    # Install cert-manager
    kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.7.1/cert-manager.yaml

    for f in k8s/**/*{.yaml,.yaml.secret}; do
        kubectl apply -f "$f"
    done

    (
        cd k8s-pulumi
        pulumi up --yes
    )
}

function deploy_nix() {
    local target="$1"
    shift
    if [ "$target" = "$(hostname)" ]; then
        colmena apply-local --config hive.nix --sudo "$@"
    else
        colmena apply --config hive.nix --on "$target" "$@"
    fi
}

tools/deage
target="$1"
shift

if [ "$target" = "k8s" ]; then
    build_containers
    deploy_k8s
else
    deploy_nix "$target" "$@"
fi
