#!/usr/bin/env bash

# Usage:
# sw
#  - start a stopwatch from 0, save start time
# sw [-r|--resume]
#  - start a stopwatch from the last saved start time (or current time if no last saved start time exists)
#  - "-r" stands for --resume

function finish {
    tput cnorm # Restore cursor
    exit 0
}

trap finish EXIT

DATE_FORMAT="+%H:%M:%S.%N"

tput civis # hide cursor

# If -r is passed, use saved start time from ~/.sw
if [[ $1 == "-r" || $1 == "--resume" ]]; then
    if [[ ! -f $HOME/.sw ]]; then
        date +%s >"$HOME/.sw"
    fi
    START_TIME=$(cat "$HOME/.sw")
else
    START_TIME=$(date +%s)
    echo -n "$START_TIME" >"$HOME/.sw"
fi

DATE_INPUT=("--date" "now-${START_TIME}sec")

while true; do
    STOPWATCH=$(TZ=UTC date "${DATE_INPUT[@]}" "$DATE_FORMAT" | sed 's/.\{7\}$//')
    printf "\r%s" "$STOPWATCH"
    sleep 0.03
done
