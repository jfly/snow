#!/usr/bin/env bash

set -euo pipefail

prompt="$1"
second_factor=""

function get_2fa() {
    mfa_id=$1
    if two_factors=$(2fa-cli 2>&1); then
        second_factor=$(echo "$two_factors" | grep "$mfa_id" | cut -f 1)
        if [ "$second_factor" ]; then
            echo "$second_factor"
        else
            echo "Successfully connected to phone, but could not find '$mfa_id' 2fa." >/dev/stderr
        fi
    else
        echo "Could not connect to phone for 2fa. You're on your own." >/dev/stderr
    fi
}

if [ "$prompt" = "(jeremy@bastion.honordev.com) Verification code: " ]; then
    second_factor=$(get_2fa "bastion")
fi

if [ -z "$second_factor" ]; then
    echo -n "$@" >/dev/stderr
    read -rs second_factor
fi

echo -n "$second_factor"
